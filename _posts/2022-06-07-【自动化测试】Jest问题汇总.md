---
layout: post
title: Jestä½¿ç”¨é—®é¢˜æ±‡æ€»
categories: 
tags: []
---


### 1. å½“åœ¨é¡¹ç›®ä¸­ä½¿ç”¨```lodash-es```ï¼ŒæŠ¥é”™ï¼š```"SyntaxError: Unexpected token export"```  
  å‚è§ï¼šhttps://stackoverflow.com/questions/42260218/jest-setup-syntaxerror-unexpected-token-export   
  å°†lodashå®‰è£…åœ¨devDependenciesã€‚```npm i -D lodash```  
  å°†jest.config.tsé…ç½®æ–‡ä»¶```moduleNameMapper```æ”¹æˆä¸‹é¢å³å¯  
  ï¼ˆäº²æµ‹åªæœ‰è¿™ä¸€ç§æ–¹å¼æœ‰æ•ˆï¼‰
    ```ts
    moduleNameMapper: {
      '^lodash-es$': 'lodash',    
    },
    ```
### 2. å½“åœ¨jestä¸­ä½¿ç”¨mock axiosæ—¶
   ```ts
    import axios from 'axios'
    jest.mock(axios)

    test('test mock axios',()=>{
      axios.get.mockResolvedValue({}) // æŠ¥å¦‚ä¸‹é”™è¯¯ï¼š
    })
   ```
   ![æŠ¥é”™ä¿¡æ¯](../assets/images/mock-axios.png)
  è§£å†³æ–¹æ³•ï¼š
   ```ts
    import axios from 'axios'
    jest.mock('axios')
    const mockedAxios = axios as jest.Mocked<typeof axios>

    // æ­£å¸¸æ‰§è¡Œ
    test('test mock axios', () => {
      mockedAxios.get.mockResolvedValue({})
      return mockedAxios
      .get(
        'https://apis.map.qq.com/ws/location/v1/ip?key=CDDBZ-FBNH2-XCYUZ-CB74S-PK35F-4ABJK&output=jsonp'
      )
      .then(res => expect(res).toEqual(resp))
    })
   ```
   å¤‡æ³¨ï¼šæ›´æ¨èçš„æ–¹æ³•æ˜¯ç›´æ¥ä½¿ç”¨[axios-mock-adapter](https://www.npmjs.com/package/axios-mock-adapter)ï¼ŒåŠŸèƒ½æ›´åŠ å¼ºå¤§

### 3. å½“åœ¨é¡¹ç›®ä¸­ä½¿ç”¨```@babel/plugin-transform-runtime```æ—¶ï¼Œä¾‹å¦‚.babelrcé…ç½®å¦‚ä¸‹
   ```json
    {
      "presets": [
        "@babel/preset-env",
        "@babel/preset-typescript"
      ],
      "plugins": [
        [
          "@babel/plugin-transform-runtime",
          {
            "corejs": {
              "version": "3",
              "proposals": true
            }
          }
        ]
      ]
    }
   ```
  æ­¤æ—¶å½“æˆ‘ä»¬åœ¨æµ‹è¯•setIntervalç­‰æ—¶ï¼Œä¼šå‡ºç°ä¸ç¬¦åˆé¢„æœŸçš„æƒ…å†µï¼Œè¿™æ˜¯å› ä¸º```@babel/plugin-transform-runtime```ä¼šæ›¿æ¢å…¨å±€çš„setIntervalã€‚

  è§£å†³æ–¹æ³•ï¼š  
  ä½¿ç”¨babel.config.cjsï¼Œæ ¹æ®å‘½ä»¤è¡Œé…ç½®babelï¼Œæ¥ä½¿æµ‹è¯•å’Œæ‰“åŒ…æ—¶ä½¿ç”¨ä¸åŒçš„babelé…ç½®ã€‚ä¾‹å¦‚ï¼Œbabel.config.cjsé…ç½®å¦‚ä¸‹ï¼š
  ```cjs
  // ä½¿ç”¨jestæµ‹è¯•æ—¶ï¼Œjestä¼šè‡ªåŠ¨è®¾ç½®ç¯å¢ƒå˜é‡NODE_ENVä¸ºâ€œtestâ€
  const config = process.env.NODE_ENV === 'test'
    ? {
        presets: [
          [
            '@babel/preset-env',
            {
              targets: {
                node: 'current',
              },
            },
          ],
          '@babel/preset-typescript',
        ],
      }
    : {
        presets: ['@babel/preset-env', '@babel/preset-typescript'],
        plugins: [
          [
            '@babel/plugin-transform-runtime',
            {
              corejs: {
                version: '3',
                proposals: true,
              },
            },
          ],
        ],
      }

  module.exports = config
  ```  
  å‚è§ï¼š[Mocked timers are not used in env with @babel/plugin-transform-runtime](https://github.com/facebook/jest/issues/9649)

### 4. æµ‹è¯•å¼‚æ­¥ä»£ç çš„æ—¶å€™æŠ¥å¦‚ä¸‹é”™è¯¯
```css
thrown: "Exceeded timeout of 5000 ms for a test.
Use jest.setTimeout(newTimeout) to increase the timeout value, if this is a long-running test."
```
è¿™æ˜¯å› ä¸ºjestæ²¡æœ‰æ•è·åˆ°ä»£ç ç»“æŸ  
å‚è§ï¼š[å®˜æ–¹æ–‡æ¡£](https://jestjs.io/zh-Hans/docs/asynchronous)

### 5. æµ‹è¯•loadScriptæ–¹æ³•ï¼Œä¸€ç›´æŠ¥é”™è¶…æ—¶
è¿™æ˜¯å› ä¸ºï¼Œè¿™æ˜¯å› ä¸ºjsdomé»˜è®¤æ˜¯ä¸åŠ è½½ä»»ä½•é¢å¤–çš„èµ„æºçš„ï¼Œå¯¼è‡´jestæ— æ³•æ•è·onloadäº‹ä»¶
å¯ä»¥åœ¨jest.config.tsä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼Œåˆ™å¯ä»¥æ­£ç¡®æ‰§è¡Œ
```ts
testEnvironmentOptions: { resources: 'usable' },
```
å‚è§ï¼š[Image.onload not fired after upgrading for 9.x to 10.x](https://github.com/jsdom/jsdom/issues/1816)

### 6. å½“æ‰§è¡Œnew JSDOMæ—¶ï¼ŒæŠ¥é”™```ReferenceError: TextEncoder is not defined```
è§£å†³æ–¹æ³•ï¼š   
ç¬¬ä¸€æ­¥ï¼šæ–°å»ºä¸€ä¸ªsetup.jsï¼ˆå¯ä»¥æ˜¯ä»»æ„åç§°ï¼‰ï¼Œå†…å®¹å¦‚ä¸‹ï¼š
```js
import { TextEncoder, TextDecoder } from 'util'
global.TextEncoder = TextEncoder
global.TextDecoder = TextDecoder
```
ç¬¬äºŒæ­¥ï¼šåœ¨jest.config.tsä¸­çš„```setupFilesAfterEnv```å±æ€§ä¸‹å¼•å…¥æ­¤jsæ–‡ä»¶  

å‚è§ï¼šhttps://github.com/inrupt/solid-client-authn-js/issues/1676  


### 7. å•å…ƒæµ‹è¯•ä¸­ï¼Œå½“æŸä¸ªæ¨¡å—ä¸­ï¼Œå¯¼å‡ºä¸¤ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­ä¸€ä¸ªæ–¹æ³•è°ƒç”¨äº†å¦å¤–ä¸€ä¸ªæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š
```help.ts```
```ts   
export function getFullName(firstName: string, lastName: string) {
  return firstName + ' ' + lastName
}

export function greet(firstName: string, lastName: string) {
  const fullName = getFullName(firstName, lastName)
  return `Hi, ${fullName}`
}
```
```help.spec.ts```
```ts
import { greet } from '../helper'
jest.mock('../helper', () => {
  const originalModule = jest.requireActual('../helper')
  return {
    ...originalModule,
    getFullName: jest.fn().mockReturnValue('mock full name'),
  }
})

describe('', () => {
  test('æµ‹è¯•', () => {
    expect(greet('XI', 'TAN')).toEqual('Hi, mock full name')
  })
})
```
æŠ¥é”™å¦‚ä¸‹ï¼š
![é”™è¯¯](../assets/images/jest-module-err1.png)

æˆ–è€…ä½¿ç”¨ä¸‹é¢çš„æµ‹è¯•æ–¹æ³•ï¼š  
```help.spec.ts```
```ts
import * as helper from '../helper'
describe('', () => {
  test('æµ‹è¯•', () => {
    jest.spyOn(helper, 'getFullName').mockReturnValue('mock full name')
    expect(helper.greet('XI', 'TAN')).toEqual('Hi, mock full name')
  })
})
```
è¿˜æ˜¯æŠ¥è·Ÿä¸Šé¢ä¸€æ ·çš„é”™è¯¯ï¼š  
![é”™è¯¯](../assets/images/jest-module-err1.png)

æŠ¥é”™åŸå› åœ¨äºï¼Œæˆ‘ä»¬mockçš„å…¶å®åªæ˜¯åœ¨*.spec.tsä¸­çš„å¼•ç”¨
æ¨èä¸¤ç§æ–¹æ³•è§£å†³ï¼š
ğŸ ç¬¬ä¸€ç§: å°†help.tsæ”¹æˆå¯¼å‡ºç±»
```ts
class Greet {
  getFullName(firstName: string, lastName: string) {
    return firstName + ' ' + lastName
  }

  greet(firstName: string, lastName: string) {
    const fullName = this.getFullName(firstName, lastName)
    return `Hi, ${fullName}`
  }
}
export const g = new Greet()
```
```help.spec.ts```
```ts
import { g } from '../helper'
describe('', () => {
  test('æµ‹è¯•', () => {
    jest.spyOn(g, 'getFullName').mockReturnValue('mock full name')
    expect(g.greet('XI', 'TAN')).toEqual('Hi, mock full name')
  })
})
```
âœ”ï¸ æµ‹è¯•å¯ä»¥é€šè¿‡  

ğŸ’¡ ç¬¬äºŒç§: é‡‡ç”¨[babel-rewire-plugin](https://www.npmjs.com/package/babel-plugin-rewire)

æ­¤æ—¶å¦‚æœæµ‹è¯•ä»£ç ä½¿ç”¨tså†™çš„ï¼Œåˆ™å¯èƒ½ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š
![é”™è¯¯](../assets/images/babel-plugin-wire-error.png)

éœ€è¦æ”¹æˆbabel-plugin-rewire-tsï¼Œä½†æ˜¯ä½¿ç”¨çš„æ—¶å€™åˆæ¶‰åŠtsç±»å‹çš„é—®é¢˜
æ‰€ä»¥è¿™é‡Œæ²¡æœ‰ä½¿ç”¨è¿™ç§æ–¹æ³•

### 8. æµ‹è¯•ä»£ç æŠ¥é”™â€œError: Not implemented: navigation (except hash changes)â€
è¿™æ˜¯å› ä¸ºåœ¨ä»£ç ä¸­ä½¿ç”¨äº†```window.location.href```ï¼Œè€Œåœ¨ jsdom ç¯å¢ƒä¸­å¹¶æ²¡æœ‰locationè¿™ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥å°±æŠ›å‡ºäº†å¼‚å¸¸ã€‚  
å¤„ç†æ–¹æ³•1ï¼šï¼ˆé‡æ–°å®šä¹‰window.locationå±æ€§ï¼‰
```ts
const mockResponse = jest.fn()
Object.defineProperty(window, 'location', {
  value: {
    replace: mockResponse,
  },
  writable: true,
})
```
å‚è§ï¼šhttps://github.com/chenxiaochun/blog/issues/64

å¤„ç†æ–¹æ³•2ï¼šä½¿ç”¨ [jest-location-mock](https://www.npmjs.com/package/jest-location-mock)  
åœ¨```setupFilesAfterEnv```ä¸­å¼•å…¥ jest-location-mockï¼Œæ¥ç€æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š
```ts
test('æµ‹è¯•historyæ¨¡å¼', () => {
  window.location.assign(
    'http://www.baidu.com?__biz=MzAxODE4MTEzMA==&mid=2650078915&idx=1&sn=4bb48827bb32c7f859141d203fe7a90e&chksm=83da63a6b4adeab096481f1b46de1f45426496d51291598b6ba005b64720029bc52917fba441&scene=21'
  )
  expect(utils.getUrlQuery('history')).toEqual({
    __biz: 'MzAxODE4MTEzMA==',
    mid: '2650078915',
    idx: '1',
    sn: '4bb48827bb32c7f859141d203fe7a90e',
    chksm:
      '83da63a6b4adeab096481f1b46de1f45426496d51291598b6ba005b64720029bc52917fba441',
    scene: '21',
  })
})

test('æµ‹è¯•å‚æ•°ä¸ºç©º', () => {
  window.location.assign('http://www.baidu.com')
  expect(utils.getUrlQuery()).toEqual({})
  expect(utils.getUrlQuery('history')).toEqual({})
})
```

âœ”ï¸ æµ‹è¯•å¯ä»¥é€šè¿‡ 

å‚è§ï¼š
* [How to mock specific module function in jest?](https://medium.com/@qjli/how-to-mock-specific-module-function-in-jest-715e39a391f4)
* [How to mock functions in the same module using Jest?](https://stackoverflow.com/questions/45111198/how-to-mock-functions-in-the-same-module-using-jest)


### é™„å½•ï¼š   
* [ä½¿ç”¨jest + jsdomæµ‹è¯•åŠ¨æ€åŠ è½½jsæ–‡ä»¶çš„ä¸´æ—¶è§£å†³æ–¹æ³•](https://xmanyou.com/jest-jsdom-test-dynamically-loading-js/)  
* [jsdom](https://github.com/jsdom/jsdom#asynchronous-script-loading)
* [setupfilesafterenvå’ŒsetupfilesåŒºåˆ«](https://stackoverflow.com/questions/58080435/when-should-i-use-setupfiles-rather-than-setupfilesafterenv)