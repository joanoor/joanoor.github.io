---
layout: post
title: ä½¿ç”¨microappæ­å»ºå¾®å‰ç«¯é¡¹ç›®å®è·µ
categories: 
tags: []
---

## å‰è¨€
æˆªè‡³ç›®å‰ï¼ˆ2022å¹´10æœˆ9æ—¥ï¼‰ï¼Œç”±äºqiankunå®˜æ–¹æ²¡æœ‰å¯¹viteä¸‹å¦‚ä½•é…ç½®è¿›è¡Œå›åº”ã€‚
![microappå’Œqiankunå¯¹æ¯”](../assets/images/microapp%E5%92%8Cqiankun%E5%AF%B9%E6%AF%94.webp)

ç”±äºviteå¼€å‘ä½“éªŒå¾ˆé¦™ï¼Œæ‰€ä»¥æœ€ç»ˆé‡‡ç”¨microappã€‚

è¿™é‡Œä¸»è¦æ˜¯æ¢è®¨ä¸»ã€å­åº”ç”¨ä½¿ç”¨viteçš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•è¿›è¡Œé…ç½®

## æ­¥éª¤
### ä¸»åº”ç”¨
1. å®‰è£…ä¾èµ– ```npm i @micro-zoe/micro-app```
2. ä¸»åº”ç”¨main.tsä¸­æ·»åŠ å¦‚ä¸‹ä»£ç 
   ```ts
    import microApp from '@micro-zoe/micro-app'
    microApp.start()

    // å½“å­åº”ç”¨æ˜¯viteæˆ–react16ã€react17æ—¶ï¼Œéœ€è¦é…ç½®å¦‚ä¸‹
    microApp.start({
      plugins: {
        modules: {  
          'appname-vite': [ // è¿™é‡Œçš„æ¨¡å—åç§°ä¸é¡µé¢ä¸­<micro-app name="appname-vite"> ä¿æŒä¸€è‡´
            {
              loader(code) {
                // è¿™é‡Œ /basename/ éœ€è¦å’Œå­åº”ç”¨vite.config.jsä¸­baseçš„é…ç½®ä¿æŒä¸€è‡´
                // å› ä¸ºå½“å­åº”ç”¨æ˜¯viteçš„æ—¶å€™ï¼Œå¿…é¡»å…³é—­jsæ²™ç®±ï¼Œè¿™æ ·ä¼šå¯¼è‡´baserouteå¤±æ•ˆï¼Œæ‰€ä»¥è¿™é‡Œæ‰‹åŠ¨å¤„ç†ä¸€ä¸‹
                if (process.env.NODE_ENV === 'development') {
                  code = code.replace(
                    /(from|import)(\s*['"])(\/child\/vite\/)/g,
                    all => {
                      return all.replace(
                        '/child/vite/',
                        'http://localhost:4001/child/vite/'
                      )
                    }
                  )
                }
                return code
              },
            },
          ],
          // è§£å†³create-react-appä¸­sockjs-nodeæŠ¥é”™çš„é—®é¢˜
          'appname-react16': [{
            loader(code) {
              if (process.env.NODE_ENV === 'development' && code.indexOf('sockjs-node') > -1) {
                code = code.replace('window.location.port', '4004')
              }
              return code
            }
          }],
          // è§£å†³create-react-appä¸­sockjs-nodeæŠ¥é”™çš„é—®é¢˜
          'appname-react17': [{
            loader(code) {
              if (process.env.NODE_ENV === 'development' && code.indexOf('sockjs-node') > -1) {
                code = code.replace('window.location.port', '4005')
              }
              return code
            }
          }],
        },
      },
    })

    
   ```
3. åœ¨è·¯ç”±é¡µé¢ä¸­åµŒå…¥å­åº”ç”¨
   ```html
   <!-- my-page.vue -->
    <template>
      <div>
        <h1>å­åº”ç”¨</h1>
        <!-- 
          name(å¿…ä¼ )ï¼šåº”ç”¨åç§°
          url(å¿…ä¼ )ï¼šåº”ç”¨åœ°å€ï¼Œä¼šè¢«è‡ªåŠ¨è¡¥å…¨ä¸ºhttp://localhost:3000/index.html
          baseroute(å¯é€‰)ï¼šåŸºåº§åº”ç”¨åˆ†é…ç»™å­åº”ç”¨çš„åŸºç¡€è·¯ç”±ï¼Œå°±æ˜¯ä¸Šé¢çš„ `/my-page`
        -->
        <micro-app name='app1' url='http://localhost:3000/' baseroute='/my-page'></micro-app>
      </div>
    </template>

   ```

### å­åº”ç”¨
1. è®¾ç½®åŸºç¡€è·¯ç”±(å¦‚æœåŸºåº§åº”ç”¨æ˜¯historyè·¯ç”±ï¼Œå­åº”ç”¨æ˜¯hashè·¯ç”±ï¼Œè¿™ä¸€æ­¥å¯ä»¥çœç•¥)
   ```js
    // main.js
    import Vue from 'vue'
    import VueRouter from 'vue-router'
    import routes from './router'

    const router = new VueRouter({
      // ğŸ‘‡ è®¾ç½®åŸºç¡€è·¯ç”±ï¼Œå­åº”ç”¨å¯ä»¥é€šè¿‡window.__MICRO_APP_BASE_ROUTE__è·å–åŸºåº§ä¸‹å‘çš„baserouteï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®baserouteå±æ€§ï¼Œåˆ™æ­¤å€¼é»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸²
      base: window.__MICRO_APP_BASE_ROUTE__ || '/',
      routes,
    })

    let app = new Vue({
      router,
      render: h => h(App),
    }).$mount('#app')
   ```
2. åœ¨webpack-dev-serverçš„headersä¸­è®¾ç½®è·¨åŸŸæ”¯æŒ
   ```js
    devServer: {
      headers: {
        'Access-Control-Allow-Origin': '*',
      }
    },
   ```

å‚è§ï¼š  
1.[è¯•ç”¨äº¬ä¸œmicro-appå¾®å‰ç«¯æ¡†æ¶,å…¼å®¹vite](https://juejin.cn/post/7117503052702613511)